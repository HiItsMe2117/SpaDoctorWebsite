<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Dashboard - Spa Doctors</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="/js/analytics.js"></script>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <a href="/" class="logo">Spa Doctors</a>
                <a href="tel:+18562667293" class="phone-header">📞 (856) 266-7293</a>
                <div class="mobile-menu" onclick="toggleMenu()">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                <nav id="nav">
                    <ul>
                        <li><a href="/services">Services</a></li>
                        <li><a href="/gallery">Gallery</a></li>
                        <li><a href="/about">About</a></li>
                        <li><a href="/contact">Contact</a></li>
                        <li><a href="/blog">Blog</a></li>
                        <li><a href="/dashboard" class="active">Dashboard</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <main>
        <section class="hero">
            <div class="container">
                <h1>Business Dashboard</h1>
                <p>Manage your business analytics, media content, and social media presence all in one place.</p>
                <button onclick="refreshData()" class="cta-button">Refresh Data</button>
            </div>
        </section>

        <section class="section">
            <div class="container">
                <!-- Dashboard Tab Navigation -->
                <div class="dashboard-tabs">
                    <button class="tab-button active" onclick="switchTab('analytics')">
                        📊 Analytics
                    </button>
                    <button class="tab-button" onclick="switchTab('media')">
                        📸 Media Manager
                    </button>
                    <button class="tab-button" onclick="switchTab('social')">
                        📱 Social Posts
                    </button>
                    <button class="tab-button" onclick="switchTab('settings')">
                        ⚙️ Settings
                    </button>
                </div>

                <!-- Analytics Tab Content -->
                <div id="analytics-tab" class="tab-content active" style="display: block;">
                    <div id="loading" style="text-align: center; padding: 2rem;">
                        <p>Loading analytics data...</p>
                    </div>
                    
                    <div id="analytics-content" style="display: none;">
                    <!-- Overall Stats -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 2rem; margin-bottom: 3rem;">
                        <div style="background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center;">
                            <h3 style="color: #2563eb; margin-bottom: 1rem;">📞 Total Contacts</h3>
                            <div id="total-contacts" style="font-size: 2.5rem; font-weight: bold; color: #334155;">0</div>
                            <p style="color: #64748b; margin-top: 0.5rem;">Customer inquiries</p>
                        </div>
                        <div style="background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center;">
                            <h3 style="color: #2563eb; margin-bottom: 1rem;">📊 Blog Views</h3>
                            <div id="total-blog-views" style="font-size: 2.5rem; font-weight: bold; color: #334155;">0</div>
                            <p style="color: #64748b; margin-top: 0.5rem;">Blog page visits</p>
                        </div>
                        <div style="background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center;">
                            <h3 style="color: #2563eb; margin-bottom: 1rem;">📖 Article Reads</h3>
                            <div id="total-expansions" style="font-size: 2.5rem; font-weight: bold; color: #334155;">0</div>
                            <p style="color: #64748b; margin-top: 0.5rem;">"Read More" clicks</p>
                        </div>
                    </div>
                    
                    <!-- Business Intelligence -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 2rem; margin-bottom: 3rem;">
                        <!-- Service Requests -->
                        <div style="background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <h2 style="color: #334155; margin-bottom: 2rem;">🔧 Service Demand</h2>
                            <div id="service-requests"></div>
                        </div>
                        
                        <!-- Contact Trends -->
                        <div style="background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <h2 style="color: #334155; margin-bottom: 2rem;">📅 Contact Trends</h2>
                            <div id="contact-trends"></div>
                        </div>
                    </div>

                    <!-- Article Performance -->
                    <div style="background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 3rem;">
                        <h2 style="color: #334155; margin-bottom: 2rem;">📈 Article Performance</h2>
                        <div id="article-stats"></div>
                    </div>

                    <!-- Daily Views Chart -->
                    <div style="background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <h2 style="color: #334155; margin-bottom: 2rem;">📅 Daily Blog Views</h2>
                        <div id="daily-views"></div>
                    </div>
                </div>

                <!-- Media Manager Tab Content -->
                <div id="media-tab" class="tab-content" style="display: none;">
                    <h2 style="color: #334155; margin-bottom: 2rem;">📸 Media Manager</h2>
                    
                    <!-- Upload Section -->
                    <div style="background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 2rem;">
                        <h3 style="color: #2563eb; margin-bottom: 1.5rem;">Upload New Media</h3>
                        <form id="mediaUploadForm" enctype="multipart/form-data" style="display: grid; gap: 1rem;">
                            <div style="border: 2px dashed #cbd5e1; border-radius: 10px; padding: 2rem; text-align: center; cursor: pointer;" onclick="document.getElementById('mediaFiles').click()">
                                <input type="file" id="mediaFiles" name="mediaFiles" multiple accept="image/*,video/*" style="display: none;" onchange="handleFileSelect(this)">
                                <div id="dropZoneContent">
                                    <p style="color: #64748b; margin-bottom: 1rem; font-size: 1.1rem;">📁 Click to upload or drag & drop files here</p>
                                    <p style="color: #94a3b8; font-size: 0.9rem;">Supports: JPG, PNG, GIF, MP4, MOV (Max 10MB per file)</p>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <input type="text" id="mediaTitle" name="title" placeholder="Title (optional)" style="padding: 0.8rem; border: 2px solid #f8fafc; border-radius: 5px;">
                                <input type="text" id="mediaTags" name="tags" placeholder="Tags (comma separated)" style="padding: 0.8rem; border: 2px solid #f8fafc; border-radius: 5px;">
                            </div>
                            <button type="submit" class="btn" style="justify-self: start;">Upload Media</button>
                        </form>
                    </div>

                    <!-- Media Library -->
                    <div style="background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <h3 style="color: #2563eb; margin-bottom: 1.5rem;">Media Library</h3>
                        <div id="mediaLibrary" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem;">
                            <p style="color: #64748b; text-align: center; grid-column: 1 / -1; padding: 2rem;">No media uploaded yet. Upload your first image or video above!</p>
                        </div>
                    </div>
                </div>

                <!-- Social Posts Tab Content -->
                <div id="social-tab" class="tab-content" style="display: none;">
                    <h2 style="color: #334155; margin-bottom: 2rem;">📱 Social Media Posts</h2>
                    
                    <!-- Create New Post -->
                    <div style="background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 2rem;">
                        <h3 style="color: #2563eb; margin-bottom: 1.5rem;">Create New Post</h3>
                        <form id="socialPostForm" style="display: grid; gap: 1rem;">
                            <textarea id="postContent" name="content" placeholder="Write your post content here..." style="min-height: 120px; padding: 1rem; border: 2px solid #f8fafc; border-radius: 5px; resize: vertical;"></textarea>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Select Media (optional)</label>
                                    <select id="postMedia" name="media" style="width: 100%; padding: 0.8rem; border: 2px solid #f8fafc; border-radius: 5px;">
                                        <option value="">No media</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Post to Platforms</label>
                                    <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center; padding: 0.8rem; border: 2px solid #f8fafc; border-radius: 5px;">
                                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                            <input type="checkbox" name="platforms" value="google" checked> 🏢 Google Business
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                            <input type="checkbox" name="platforms" value="facebook" checked> 📘 Facebook
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                            <input type="checkbox" name="platforms" value="instagram" checked> 📷 Instagram
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 1rem; align-items: center;">
                                <button type="submit" class="btn">📤 Post Now</button>
                                <button type="button" class="btn" style="background: #64748b;" onclick="schedulePost()">⏰ Schedule Post</button>
                            </div>
                        </form>
                    </div>

                    <!-- Recent Posts -->
                    <div style="background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <h3 style="color: #2563eb; margin-bottom: 1.5rem;">Recent Posts</h3>
                        <div id="recentPosts">
                            <p style="color: #64748b; text-align: center; padding: 2rem;">No social media posts yet. Create your first post above!</p>
                        </div>
                    </div>
                </div>

                <!-- Settings Tab Content -->
                <div id="settings-tab" class="tab-content" style="display: none;">
                    <h2 style="color: #334155; margin-bottom: 2rem;">⚙️ Settings</h2>
                    
                    <!-- Social Media Connections -->
                    <div style="background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 2rem;">
                        <h3 style="color: #2563eb; margin-bottom: 1.5rem;">Social Media Connections</h3>
                        
                        <div style="display: grid; gap: 1rem;">
                            <!-- Google Business Profile -->
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; border: 2px solid #f8fafc; border-radius: 5px;">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <span style="font-size: 1.5rem;">🏢</span>
                                    <div>
                                        <h4 style="margin: 0; color: #334155;">Google Business Profile</h4>
                                        <p style="margin: 0; color: #64748b; font-size: 0.9rem;">Post updates and photos to your business listing</p>
                                    </div>
                                </div>
                                <button id="googleConnectBtn" class="btn" style="background: #10b981;" onclick="connectGoogle()">🔗 Connect</button>
                            </div>

                            <!-- Facebook -->
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; border: 2px solid #f8fafc; border-radius: 5px;">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <span style="font-size: 1.5rem;">📘</span>
                                    <div>
                                        <h4 style="margin: 0; color: #334155;">Facebook Page</h4>
                                        <p style="margin: 0; color: #64748b; font-size: 0.9rem;">Share posts and photos to your business page</p>
                                    </div>
                                </div>
                                <button class="btn" style="background: #1877f2;" onclick="connectFacebook()">🔗 Connect</button>
                            </div>

                            <!-- Instagram -->
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; border: 2px solid #f8fafc; border-radius: 5px;">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <span style="font-size: 1.5rem;">📷</span>
                                    <div>
                                        <h4 style="margin: 0; color: #334155;">Instagram Business</h4>
                                        <p style="margin: 0; color: #64748b; font-size: 0.9rem;">Post photos and videos to your Instagram</p>
                                    </div>
                                </div>
                                <button class="btn" style="background: #e4405f;" onclick="connectInstagram()">🔗 Connect</button>
                            </div>
                        </div>
                    </div>

                    <!-- General Settings -->
                    <div style="background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <h3 style="color: #2563eb; margin-bottom: 1.5rem;">General Settings</h3>
                        
                        <div style="display: grid; gap: 1.5rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Default Post Template</label>
                                <textarea placeholder="Default content to include in posts (e.g., hashtags, contact info)" style="width: 100%; min-height: 80px; padding: 0.8rem; border: 2px solid #f8fafc; border-radius: 5px; resize: vertical;">#HotTubRepair #DenverServices #SpaExperts

Call (856) 266-7293 for professional hot tub service!</textarea>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Auto-publish Settings</label>
                                <div style="display: grid; gap: 0.5rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" checked> Automatically add contact info to posts
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" checked> Include website link in social posts
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox"> Send notification when posts are published
                                    </label>
                                </div>
                            </div>
                            
                            <button class="btn" style="justify-self: start;">💾 Save Settings</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h4>Spa Doctors</h4>
                    <p>Professional hot tub repair, maintenance, transport, and cleaning services. Fully insured and experienced.</p>
                </div>
                <div class="footer-section">
                    <h4>Analytics</h4>
                    <p>Blog Performance Tracking</p>
                    <p>Customer Engagement Metrics</p>
                    <p>Content Optimization</p>
                </div>
                <div class="footer-section">
                    <h4>Contact Info</h4>
                    <p><a href="tel:+18562667293">📞 (856) 266-7293</a></p>
                    <p>Data-Driven Service</p>
                    <p>Professional Excellence</p>
                </div>
            </div>
            <p>&copy; 2024 Spa Doctors. All rights reserved.</p>
        </div>
    </footer>

    <script>
        function toggleMenu() {
            const nav = document.getElementById('nav');
            nav.classList.toggle('active');
        }

        async function loadAnalytics() {
            try {
                const response = await fetch('/analytics-data');
                const data = await response.json();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('analytics-content').style.display = 'block';
                
                // Update overall stats
                document.getElementById('total-contacts').textContent = data.summary.totalContacts;
                document.getElementById('total-blog-views').textContent = data.summary.totalBlogViews;
                
                const totalExpansions = Object.values(data.summary.articleStats)
                    .reduce((sum, article) => sum + article.totalExpansions, 0);
                document.getElementById('total-expansions').textContent = totalExpansions;
                
                // Update service requests
                const serviceRequestsDiv = document.getElementById('service-requests');
                serviceRequestsDiv.innerHTML = '';
                
                if (Object.keys(data.summary.serviceRequests).length === 0) {
                    serviceRequestsDiv.innerHTML = '<p style="color: #64748b; text-align: center; padding: 2rem;">No service requests yet. Contact forms will show data here!</p>';
                } else {
                    Object.entries(data.summary.serviceRequests).forEach(([service, stats]) => {
                        const serviceDiv = document.createElement('div');
                        serviceDiv.style.cssText = 'border-left: 4px solid #2563eb; padding: 1rem; margin-bottom: 1rem; background: #f8fafc;';
                        
                        const topReferrer = Object.entries(stats.referrerPages)
                            .sort(([,a], [,b]) => b - a)[0]?.[0] || 'unknown';
                        
                        serviceDiv.innerHTML = `
                            <h4 style="color: #334155; margin-bottom: 0.5rem;">${service}</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; color: #64748b; font-size: 0.9rem;">
                                <span><strong>${stats.count}</strong> requests</span>
                                <span><strong>${stats.hasPhoneCount}</strong> with phone</span>
                                <span><strong>${stats.hasEmailCount}</strong> with email</span>
                                <span>From: <strong>${topReferrer}</strong></span>
                            </div>
                        `;
                        serviceRequestsDiv.appendChild(serviceDiv);
                    });
                }
                
                // Update contact trends
                const contactTrendsDiv = document.getElementById('contact-trends');
                contactTrendsDiv.innerHTML = '';
                
                if (Object.keys(data.summary.contactTrends).length === 0) {
                    contactTrendsDiv.innerHTML = '<p style="color: #64748b; text-align: center; padding: 2rem;">No contact trends yet.</p>';
                } else {
                    const sortedDays = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
                    sortedDays.forEach(day => {
                        const count = data.summary.contactTrends[day] || 0;
                        if (count > 0) {
                            const dayDiv = document.createElement('div');
                            dayDiv.style.cssText = 'display: flex; justify-content: space-between; padding: 0.5rem 1rem; margin-bottom: 0.5rem; background: #f8fafc; border-radius: 5px;';
                            dayDiv.innerHTML = `
                                <span style="color: #334155;">${day}</span>
                                <span style="color: #2563eb; font-weight: bold;">${count} contacts</span>
                            `;
                            contactTrendsDiv.appendChild(dayDiv);
                        }
                    });
                }
                
                // Update article stats
                const articleStatsDiv = document.getElementById('article-stats');
                articleStatsDiv.innerHTML = '';
                
                if (Object.keys(data.summary.articleStats).length === 0) {
                    articleStatsDiv.innerHTML = '<p style="color: #64748b; text-align: center; padding: 2rem;">No article interactions yet. Visit your blog and click "Read More" to see data here!</p>';
                } else {
                    Object.entries(data.summary.articleStats).forEach(([title, stats]) => {
                        const articleDiv = document.createElement('div');
                        articleDiv.style.cssText = 'border-left: 4px solid #2563eb; padding: 1rem; margin-bottom: 1rem; background: #f8fafc;';
                        
                        const lastRead = stats.lastExpanded ? new Date(stats.lastExpanded).toLocaleDateString() : 'Never';
                        
                        articleDiv.innerHTML = `
                            <h4 style="color: #334155; margin-bottom: 0.5rem;">${title}</h4>
                            <div style="display: flex; gap: 2rem; color: #64748b;">
                                <span><strong>${stats.totalExpansions}</strong> reads</span>
                                <span>Last read: <strong>${lastRead}</strong></span>
                            </div>
                        `;
                        articleStatsDiv.appendChild(articleDiv);
                    });
                }
                
                // Update daily blog views
                const dailyViewsDiv = document.getElementById('daily-views');
                dailyViewsDiv.innerHTML = '';
                
                if (Object.keys(data.rawData.blogPageViews).length === 0) {
                    dailyViewsDiv.innerHTML = '<p style="color: #64748b; text-align: center; padding: 2rem;">No blog views recorded yet.</p>';
                } else {
                    Object.entries(data.rawData.blogPageViews).forEach(([date, views]) => {
                        const dayDiv = document.createElement('div');
                        dayDiv.style.cssText = 'display: flex; justify-content: space-between; padding: 0.5rem 1rem; margin-bottom: 0.5rem; background: #f8fafc; border-radius: 5px;';
                        dayDiv.innerHTML = `
                            <span style="color: #334155;">${new Date(date).toLocaleDateString()}</span>
                            <span style="color: #2563eb; font-weight: bold;">${views} blog views</span>
                        `;
                        dailyViewsDiv.appendChild(dayDiv);
                    });
                }
                
            } catch (error) {
                document.getElementById('loading').innerHTML = '<p style="color: #ef4444;">Error loading analytics data. Please try again.</p>';
                console.error('Analytics error:', error);
            }
        }

        function refreshData() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('analytics-content').style.display = 'none';
            loadAnalytics();
        }

        // Tab switching functionality
        function switchTab(tabName) {
            // Hide all tab contents and remove active class
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
                tab.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected tab content and add active class
            const selectedTab = document.getElementById(tabName + '-tab');
            selectedTab.style.display = 'block';
            selectedTab.classList.add('active');
            
            // Activate selected tab button
            event.target.classList.add('active');
            
            // Load specific tab data
            if (tabName === 'analytics') {
                loadAnalytics();
            } else if (tabName === 'media') {
                loadMediaLibrary();
            } else if (tabName === 'social') {
                loadRecentPosts();
                loadMediaForSocial();
            }
        }

        // Media upload functionality
        function handleFileSelect(input) {
            const files = input.files;
            const dropZoneContent = document.getElementById('dropZoneContent');
            
            if (files.length > 0) {
                dropZoneContent.innerHTML = `
                    <p style="color: #2563eb; margin-bottom: 1rem; font-size: 1.1rem;">📁 ${files.length} file(s) selected</p>
                    <p style="color: #64748b; font-size: 0.9rem;">Click "Upload Media" below to process files</p>
                `;
            }
        }

        // Load media library
        async function loadMediaLibrary() {
            try {
                const response = await fetch('/media-library');
                const media = await response.json();
                
                const mediaLibrary = document.getElementById('mediaLibrary');
                
                if (media.length === 0) {
                    mediaLibrary.innerHTML = '<p style="color: #64748b; text-align: center; grid-column: 1 / -1; padding: 2rem;">No media uploaded yet. Upload your first image or video above!</p>';
                } else {
                    mediaLibrary.innerHTML = media.map(item => `
                        <div style="border-radius: 10px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1); cursor: pointer;" onclick="selectMedia('${item.id}')">
                            ${item.type === 'image' ? 
                                `<img src="/uploads/${item.filename}" alt="${item.title || 'Uploaded media'}" style="width: 100%; height: 150px; object-fit: cover;">` :
                                `<video style="width: 100%; height: 150px; object-fit: cover;"><source src="/uploads/${item.filename}"></video>`
                            }
                            <div style="padding: 1rem;">
                                <h4 style="margin: 0 0 0.5rem 0; color: #334155; font-size: 0.9rem;">${item.title || 'Untitled'}</h4>
                                <p style="margin: 0; color: #64748b; font-size: 0.8rem;">${new Date(item.uploadDate).toLocaleDateString()}</p>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading media library:', error);
            }
        }

        // Load media options for social posts
        async function loadMediaForSocial() {
            try {
                const response = await fetch('/media-library');
                const media = await response.json();
                
                const select = document.getElementById('postMedia');
                select.innerHTML = '<option value="">No media</option>' + 
                    media.map(item => `<option value="${item.id}">${item.title || item.filename}</option>`).join('');
            } catch (error) {
                console.error('Error loading media for social:', error);
            }
        }

        // Load recent social posts
        async function loadRecentPosts() {
            try {
                const response = await fetch('/social-posts');
                const posts = await response.json();
                
                const recentPosts = document.getElementById('recentPosts');
                
                if (posts.length === 0) {
                    recentPosts.innerHTML = '<p style="color: #64748b; text-align: center; padding: 2rem;">No social media posts yet. Create your first post above!</p>';
                } else {
                    recentPosts.innerHTML = posts.slice(0, 5).map(post => `
                        <div style="border-left: 4px solid #2563eb; padding: 1rem; margin-bottom: 1rem; background: #f8fafc; border-radius: 5px;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                <h4 style="margin: 0; color: #334155;">${post.content.substring(0, 50)}${post.content.length > 50 ? '...' : ''}</h4>
                                <span style="color: #64748b; font-size: 0.8rem;">${new Date(post.postDate).toLocaleDateString()}</span>
                            </div>
                            <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                                ${post.platforms.map(platform => {
                                    const icons = { google: '🏢', facebook: '📘', instagram: '📷' };
                                    return `<span style="background: #e2e8f0; padding: 0.2rem 0.5rem; border-radius: 3px; font-size: 0.8rem;">${icons[platform]} ${platform}</span>`;
                                }).join('')}
                            </div>
                            <p style="margin: 0; color: #64748b; font-size: 0.9rem;">Status: ${post.status}</p>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading recent posts:', error);
            }
        }

        // Social media connection functions
        function connectGoogle() {
            window.location.href = '/auth/google';
        }

        function disconnectGoogle() {
            if (confirm('Are you sure you want to disconnect your Google Business Profile?')) {
                fetch('/auth/google/disconnect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        alert('Google Business Profile disconnected successfully');
                        updateGoogleConnectionStatus(false);
                    } else {
                        alert('Failed to disconnect: ' + (result.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    alert('Error disconnecting: ' + error.message);
                });
            }
        }

        function updateGoogleConnectionStatus(connected) {
            const button = document.getElementById('googleConnectBtn');
            if (connected) {
                button.textContent = '🔗 Connected';
                button.style.background = '#10b981';
                button.onclick = disconnectGoogle;
                button.title = 'Click to disconnect';
            } else {
                button.textContent = '🔗 Connect';
                button.style.background = '#10b981';
                button.onclick = connectGoogle;
                button.title = 'Click to connect';
            }
        }

        function connectFacebook() {
            alert('Facebook integration coming soon! This will allow you to post to your business page.');
        }

        function connectInstagram() {
            alert('Instagram integration coming soon! This will allow you to post photos and videos.');
        }

        function schedulePost() {
            alert('Post scheduling feature coming soon! This will allow you to schedule posts for optimal times.');
        }

        // Check for Google connection status on page load
        async function checkGoogleConnectionStatus() {
            try {
                const response = await fetch('/social-settings');
                const settings = await response.json();
                updateGoogleConnectionStatus(settings.google?.connected || false);
            } catch (error) {
                console.error('Error checking Google connection status:', error);
            }
        }

        // Check for connection success/error messages from URL
        function checkUrlMessages() {
            const urlParams = new URLSearchParams(window.location.search);
            const googleConnected = urlParams.get('google_connected');
            
            if (googleConnected === 'success') {
                alert('Google Business Profile connected successfully!');
                updateGoogleConnectionStatus(true);
                // Remove the parameter from URL
                window.history.replaceState({}, document.title, window.location.pathname);
            } else if (googleConnected === 'error') {
                alert('Failed to connect Google Business Profile. Please try again.');
                // Remove the parameter from URL
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        // Form submissions
        document.addEventListener('DOMContentLoaded', function() {
            // Load analytics when page loads
            loadAnalytics();
            
            // Check Google connection status
            checkGoogleConnectionStatus();
            
            // Check for URL messages
            checkUrlMessages();

            // Media upload form
            document.getElementById('mediaUploadForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                
                try {
                    const response = await fetch('/upload-media', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        alert('Media uploaded successfully!');
                        this.reset();
                        document.getElementById('dropZoneContent').innerHTML = `
                            <p style="color: #64748b; margin-bottom: 1rem; font-size: 1.1rem;">📁 Click to upload or drag & drop files here</p>
                            <p style="color: #94a3b8; font-size: 0.9rem;">Supports: JPG, PNG, GIF, MP4, MOV (Max 10MB per file)</p>
                        `;
                        loadMediaLibrary();
                    } else {
                        alert('Upload failed: ' + (result.error || 'Unknown error'));
                    }
                } catch (error) {
                    alert('Upload error: ' + error.message);
                }
            });

            // Social post form
            document.getElementById('socialPostForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const platforms = Array.from(document.querySelectorAll('input[name="platforms"]:checked')).map(cb => cb.value);
                
                const postData = {
                    content: formData.get('content'),
                    media: formData.get('media'),
                    platforms: platforms
                };
                
                try {
                    const response = await fetch('/create-social-post', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(postData)
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        alert('Post created successfully!');
                        this.reset();
                        loadRecentPosts();
                    } else {
                        alert('Post failed: ' + (result.error || 'Unknown error'));
                    }
                } catch (error) {
                    alert('Post error: ' + error.message);
                }
            });
        });
    </script>
</body>
</html>